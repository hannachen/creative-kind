"use strict";paper.install(window),function(o,t){o(function(){patch.init()})}(jQuery,window);var colors=function(o){function t(){if(a.length>0){var o=parseInt(a.find(".selected-set").val()),t=r.filter("[value="+o+"]"),i=a.find("[for="+t.attr("id")+"]"),d=i.find(".swatch");l.value=o,t.attr("checked",!0),e(c,d),n()}}function e(t,e){var n=[];t.each(function(t){var a=o(this),r=e.eq(t).data("hex");console.log("COLOR SET UPDATE",a),a.attr("data-color",r),a.css("background-color",r),n.push(r)}),i.trigger({type:"changeSet",colorData:n})}function n(){r.on("change",function(t){t.preventDefault(),console.log("current selection",t.currentTarget);var n=o(t.currentTarget),r=a.find("[for="+n.attr("id")+"]"),i=r.find(".swatch");e(c,i)})}var a=o(".palette-selector"),r=a.find(".selection"),i=o(".color-palette"),c=i.find(".color-button"),l=document.getElementById("selectedSet");return{init:function(){t()},deinit:function(){}}}(jQuery),patch=function(o){function t(){paper.setup("coloring-area");var o=O.find(".color-index-data").text().trim();o&&(F=o.split(",")),console.log("data string",o),project.importSVG("/img/grid-1.svg",{expandShapes:!1,onLoad:e}),view.draw(),S(),i(),u()}function e(o){y=o,m(o),o.hasChildren()&&o.children.gridareas&&(console.log(o.firstChild),o.firstChild.remove(),console.log("item svg",o.children),L=o.children.gridareas.children,_.forEach(L,function(o,t){o.data.colorIndex=F[t],a(o)})),o.hasChildren()&&o.children.lines&&(I=o.children.lines),c(),colors.init()}function n(){r(),D&&t(),o(".start-patch-form").length&&(console.log("start patch"),o(".carousel").slick())}function a(o){o.strokeScaling=!1,Modernizr.touch||(o.onMouseEnter=g,o.onMouseLeave=p),o.onClick=f,o.selectedColor=z?"#00ecde":"#009dec"}function r(){k=o(".start-patch-form")}function i(){var t=o(".toolbar");t.find('[data-tool="clear"]').on("touchstart click",function(){h()}),t.find('[data-tool="line-toggle"]').on("touchstart click",function(){I&&(I.visible=!I.visible,view.draw())})}function c(){Q.on("touchstart click",d),R.on("touchstart click",h),G.on("changeSet",function(o){console.log("changeset",M.filter(":checked").val()),j=o.colorData,console.log("colourSet",j),A.value=M.filter(":checked").val(),_.forEach(L,l),view.draw()})}function l(o,t){if(console.log("shape area",o),console.log("setting colour...",o.data.colorIndex),console.log(j[o.data.colorIndex]),console.log("color index data",F[t]),void 0!==o&&(null!==F[t]||void 0===F[t])){var e=o.fillColor.toCSS(!0),n=j[o.data.colorIndex];console.log("current:",e),console.log("new:",n),n&&n!==e&&(o.fillColor=n)}}function d(o){var t=o.currentTarget.getAttribute("data-index"),e=j[t];_.forEach(T,function(o){o.fillColor=e,o.fillColor.alpha=B,o.data.colorIndex=t,console.log("apply color",e)}),T.length<=1&&h(),view.draw()}function s(t){console.log("SAVING...",t);var e=t.currentTarget.getAttribute("data-target"),n=o(e),a=paper.project.exportSVG({asString:!0}),r=new DOMParser,i=r.parseFromString(a,"image/svg+xml"),c=o(i).find("#gridareas"),l=c.find("path"),d=[],s=[],u=t.currentTarget.value.toLowerCase(),f=n.attr("action")+"/"+u;console.log(f),_.forEach(L,function(o){s.push(o.data.colorIndex)}),l.each(function(o,t){console.log(t),d.push(t.getAttribute("fill"))}),o.post(f,{patchData:{colors:d,colorIndexData:s,colorSet:A.value}},function(o){console.log(o),window.location=o.url},"json")}function u(){console.log("starting form action listeners....");var t=o("#formActions");t.on("submit",function(o){o.preventDefault()}),t.on("click",".action-button",s)}function f(o){z?(_.includes(T,o.target)?(w(o.target),_.remove(T,o.target)):v(o.target),T.length>1?R.prop("disabled",!1):R.prop("disabled",!0)):h(),view.draw()}function g(o){o.target.opacity=B}function p(o){o.target.opacity=1}function h(){_.forEach(T,w),T=[],R.prop("disabled",!0),view.draw()}function v(o){T.push(o),o.selected=!0,o.fillColor.alpha=B}function w(o){console.log("clearing..",o),o.selected=!1,o.fillColor.alpha=1}function m(o){var t=o.bounds.x+o.bounds.width,e=o.bounds.y+o.bounds.height,n=C()/t,a=C()/2,r=e*n/2;o.scale(n),o.position=[a,r],view.draw()}function S(){b(),window.onresize=function(){b(),m(y)}}function b(){var o=C(),t=x(),e=new Size(o,t);view.viewSize=e}function C(){var o=getComputedStyle(E),t=E.clientWidth;return t-=parseFloat(o.paddingLeft)+parseFloat(o.paddingRight),t-=parseFloat(o.marginLeft)+parseFloat(o.marginRight)}function x(){var o=getComputedStyle(E),t=E.clientHeight;return t-=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom),t-=parseFloat(o.marginTop)+parseFloat(o.marginBottom)}var y,I,k,E=document.getElementById("canvas-container"),D=document.getElementById("coloring-area"),F=[],T=[],j=[],A=document.getElementById("selectedSet"),B=.8,L=[],z=!0,M=o(".color-sets .selection"),G=o(".color-palette"),O=o("#saveData"),Q=G.find(".color-button"),R=o("#apply-color");return{init:function(){n()},deinit:function(){}}}(jQuery);