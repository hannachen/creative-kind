"use strict";!function(o,t){paper.install(t);var n=document.body.id;console.log("CURRENT PAGE",n),o(function(){switch(n){case"view-patch":viewPatch.init();break;case"edit-patch":console.log("INIT???"),patch.init()}})}(jQuery,window);var colors=function(o){function t(){if(i.length>0){var o=parseInt(i.find(".selected-set").val()),t=a.filter("[value="+o+"]"),c=i.find("[for="+t.attr("id")+"]"),d=c.find(".swatch");r.value=o,t.attr("checked",!0),n(l,d),e()}}function n(t,n){var e=[];t.each(function(t){var i=o(this),a=n.eq(t).data("hex");console.log("COLOR SET UPDATE",i),i.attr("data-color",a),i.css("background-color",a),e.push(a)}),c.trigger({type:"changeSet",colorData:e})}function e(){a.on("change",function(t){t.preventDefault(),console.log("current selection",t.currentTarget);var e=o(t.currentTarget),a=i.find("[for="+e.attr("id")+"]"),c=a.find(".swatch");n(l,c)})}var i=o(".palette-selector"),a=i.find(".selection"),c=o(".color-palette"),l=c.find(".color-button"),r=document.getElementById("selectedSet");return{init:function(){t()},deinit:function(){}}}(jQuery),patch=function(o){function t(){paper.setup("coloring-area");var o=M.find(".color-index-data").text().trim();o&&(F=o.split(",")),console.log("data string",o),project.importSVG("/img/grid-1.svg",{expandShapes:!1,onLoad:n}),view.draw(),S(),c(),f()}function n(o){x=o,b(o),o.hasChildren()&&o.children.gridareas&&(console.log(o.firstChild),o.firstChild.remove(),console.log("item svg",o.children),P=o.children.gridareas.children,_.forEach(P,function(o,t){o.data.colorIndex=F[t],i(o)})),o.hasChildren()&&o.children.lines&&(E=o.children.lines),l(),colors.init()}function e(){a(),D&&t(),o(".start-patch-form").length&&(console.log("start patch"),o(".carousel").slick())}function i(o){o.strokeScaling=!1,Modernizr.touch||(o.onMouseEnter=p,o.onMouseLeave=h),o.onClick=g,o.selectedColor=R?"#00ecde":"#009dec"}function a(){I=o(".start-patch-form")}function c(){var t=o(".toolbar");t.find('[data-tool="clear"]').on("touchstart click",function(){v()}),t.find('[data-tool="line-toggle"]').on("touchstart click",function(){E&&(E.visible=!E.visible,view.draw())})}function l(){Q.on("touchstart click",d),N.on("touchstart click",v),G.on("changeSet",function(o){console.log("changeset",z.filter(":checked").val()),A=o.colorData,console.log("colourSet",A),B.value=z.filter(":checked").val(),_.forEach(P,r),view.draw()})}function r(o,t){if(console.log("shape area",o),console.log("setting colour...",o.data.colorIndex),console.log(A[o.data.colorIndex]),console.log("color index data",F[t]),void 0!==o&&(null!==F[t]||void 0===F[t])){var n=o.fillColor.toCSS(!0),e=A[o.data.colorIndex];console.log("current:",n),console.log("new:",e),e&&e!==n&&(o.fillColor=e)}}function d(o){var t=o.currentTarget.getAttribute("data-index"),n=A[t];_.forEach(j,function(o){o.fillColor=n,o.fillColor.alpha=L,o.data.colorIndex=t,console.log("apply color",n)}),j.length<=1&&v(),view.draw()}function s(t){console.log("SAVING...",t);var n=o(t.currentTarget.getAttribute("data-target")),e=t.currentTarget.value.toLowerCase(),i=n.attr("action")+"/"+e;if(console.log(i),"complete"===e){console.log("TEST");var a=o("#submit-patch-modal");a.find(".btn").on("click",function(){o(this).off("click")}),a.find(".btn-submit-design").on("click",function(){u(i)}),a.modal("show")}else u(i)}function u(t){var n=paper.project.exportSVG({asString:!0}),e=new DOMParser,i=e.parseFromString(n,"image/svg+xml"),a=o(i).find("#gridareas"),c=a.find("path"),l=[],r=[];_.forEach(P,function(o){l.push(o.data.colorIndex)}),c.each(function(o,t){r.push(t.getAttribute("fill"))}),o.post(t,{patchData:{colors:r,colorIndexData:l,colorSet:B.value}},function(o){console.log(o),window.location=o.url},"json")}function f(){console.log("starting form action listeners....");var t=o("#formActions");t.on("submit",function(o){o.preventDefault()}),t.on("click",".action-button",s)}function g(o){R?(_.includes(j,o.target)?(w(o.target),_.remove(j,o.target)):m(o.target),j.length>1?N.prop("disabled",!1):N.prop("disabled",!0)):v(),view.draw()}function p(o){o.target.opacity=L}function h(o){o.target.opacity=1}function v(){_.forEach(j,w),j=[],N.prop("disabled",!0),view.draw()}function m(o){j.push(o),o.selected=!0,o.fillColor.alpha=L}function w(o){console.log("clearing..",o),o.selected=!1,o.fillColor.alpha=1}function b(o){var t=o.bounds.x+o.bounds.width,n=o.bounds.y+o.bounds.height,e=C()/t,i=C()/2,a=n*e/2;o.scale(e),o.position=[i,a],view.draw()}function S(){k(),window.onresize=function(){k(),b(x)}}function k(){var o=C(),t=y(),n=new Size(o,t);view.viewSize=n}function C(){var o=getComputedStyle(T),t=T.clientWidth;return t-=parseFloat(o.paddingLeft)+parseFloat(o.paddingRight),t-=parseFloat(o.marginLeft)+parseFloat(o.marginRight)}function y(){var o=getComputedStyle(T),t=T.clientHeight;return t-=parseFloat(o.paddingTop)+parseFloat(o.paddingBottom),t-=parseFloat(o.marginTop)+parseFloat(o.marginBottom)}var x,E,I,T=document.getElementById("canvas-container"),D=document.getElementById("coloring-area"),F=[],j=[],A=[],B=document.getElementById("selectedSet"),L=.8,P=[],R=!0,z=o(".color-sets .selection"),G=o(".color-palette"),M=o("#saveData"),Q=G.find(".color-button"),N=o("#apply-color");return{init:function(){e()},deinit:function(){}}}(jQuery),viewPatch=function(o){function t(){if(a.length&&(n(),c.length)){var o=a.clone();o.append('<button class="btn" data-dismiss="modal">Skip</button>'),o.appendTo(c.find(".modal-footer"))}}function n(){a.find(".download-link").on("click",e),a.find(".social-link a").on("click",i)}function e(o){o.preventDefault()}function i(o){o.preventDefault()}var a=o(".patch-actions"),c=o("#flash-modal");return{init:function(){t()},deinit:function(){}}}(jQuery);